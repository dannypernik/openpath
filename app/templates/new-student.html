{% extends "base.html" %}

{% block title %}
  New Student Form
{% endblock title %}

{% block content %}
<div class="container">
  <form method="POST" action="{{ url_for('main.new_student') }}">
    {{ form.hidden_tag() }}

    <h3 class="fw-bold">Student information</h3>
    <div class="row">
      <div class="mb-3 col-6">
      {{ form.student_first_name }}
      </div>
      <div class="mb-3 col-6">
      {{ form.student_last_name }}
      </div>
    </div>
    <div class="row">
      <div class="mb-3 col-12">
      {{ form.student_email }}
      </div>
    </div>
    <div class="row">
      <div class="col-12">
      {{ form.student_phone }}
      </div>
    </div>

    <div class="row mb-4">
      <div class="mt-3 col-12 col-md-5">
        {{ form.grad_year.label }}<br>
        {{ form.grad_year }}
      </div>

      <div class="mt-3 d-flex align-items-end col-12 col-md-7">
        <div>
          {{ form.subject.label }}<br>
          <select id="subject-select">
            <option value="sat/act">SAT/ACT prep</option>
            <option value="sat">SAT prep</option>
            <option value="act">ACT prep</option>
            <option value="math">Math</option>
            <option value="english">English/Reading</option>
            <option value="science">Science</option>
            <option value="stats">Statistics</option>
            <option value="executive-functioning">Study skills</option>
            <option value="">Other</option>
          </select>
        </div>
        <div>
          {{ form.subject(class="d-none mb-0") }}
        </div>
        <div id="create-folder-div" class="align-self-end mb-2 ms-3 {% if not current_user.is_admin %}d-none{% endif %}">
          {{ form.create_student_folder }}
          {{ form.create_student_folder.label }}
        </div>
      </div>
    </div>

    <div class="row mb-3">
      <div class="d-flex align-items-end col-12 col-md-8">
        <div>
          {{ form.timezone.label }}<br>
          <select id="tz-select">
            <option value="" selected disabled>--</option>
            <option value="America/Los_Angeles">US Pacific</option>
            <option value="America/Denver">US Mountain</option>
            <option value="America/Chicago">US Central</option>
            <option value="America/New_York">US Eastern</option>
            <option value="">Other</option>
          </select>
        </div>
        <div>
          {{ form.timezone(class="d-none mb-0") }}
        </div>
      </div>
    </div>

    <div class="row align-items-end {% if not current_user.is_admin %}d-none{% endif %}">
      <div class="mb-2 col-12 col-md-3">
        {{ form.tutor.label }}<br>
        <select id="tutor" name="tutor" class="form-control">
          {% for tutor in tutors %}
            <option value="{{ tutor.id }}" data-location="{{ tutor.location }}">{{ full_name(tutor) }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-12 col-md-5">
        {{ form.location }}
      </div>
      <div class="mb-2 col-12 col-md-3 offset-md-1">
        {{ form.status.label }}<br>
        {{ form.status }}
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        {% for t in tests %}
          <div class="row my-4 g-0">
            <h4 class="mb-1">Target {{ t.upper() }} dates</h4>
            <div class="d-flex flex-wrap">
              {% for d in upcoming_dates %}
                {% if d.test == t %}
                  <div class="test-date my-1 mx-2">
                    <label for="td-{{ d.id }}" class="text-nowrap">
                      {{ d.date.strftime('%B %-d') }}
                    </label>
                    <select id="td-{{ d.id }}" name="test_dates">
                      <option value="{{ d.id }}-none">--</option>
                      <option value="{{ d.id }}-interested">Interested</option>
                      <option value="{{ d.id }}-registered">Registered</option>
                    </select>
                  </div>
                {% endif %}
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <div class="row">
      <div class="col-12">
        <h4>{{ form.notes.label }}</h4>
        {{ form.notes }}
      </div>
    </div>


    <h3 class="fw-bold">Parent information</h3>
    <div class="row">
      <div class="col-12">
        {{ form.parent_id(class="my-2") }}
      </div>
    </div>

    <div id="new-parent-info">
      <div class="row">
        <div class="mb-3 col-6">
        {{ form.parent_first_name }}
        </div>
        <div class="mb-3 col-6">
        {{ form.parent_last_name }}
        </div>
      </div>
      <div class="row">
        <div class="mb-3 col-12">
        {{ form.parent_email }}
        </div>
      </div>
      <div class="row">
        <div class="mb-3 col-12">
        {{ form.parent_phone }}
        </div>
      </div>
    </div>

    <h3 class="mt-3 fw-bold">Additional parent information (optional)</h3>
    <div class="row">
      <div class="mb-3 col-6">
      {{ form.parent2_first_name }}
      </div>
      <div class="mb-3 col-6">
      {{ form.parent2_last_name }}
      </div>
    </div>
    <div class="row">
      <div class="mb-3 col-12">
      {{ form.parent2_email }}
      </div>
    </div>
    <div class="row">
      <div class="col-12">
      {{ form.parent2_phone }}
      </div>
    </div>

    <div class="mb-3 text-center">
      {{ hcaptcha }}
    </div>

    <div class="text-center">
      <button type="submit" class="btn btn-primary">Submit</button>
    </div>
  </form>
</div>
{% endblock content %}


{% block end_scripts %}
  <script src="{{ url_for('static', filename='js/phone-input.js') }}"></script>

  <script>
    const selectElement = document.getElementById('tz-select');
    const timezoneText = document.getElementById('timezone');

    selectElement.addEventListener('change', function() {
      const selectedValue = selectElement.value;
      timezoneText.value = selectedValue;
      if (selectedValue === "") {
        timezoneText.classList.remove('d-none');
      } //
      else {
        timezoneText.classList.add('d-none');
      }
    });

    const subjectSelect = document.getElementById('subject-select');
    const subjectText = document.getElementById('subject');
    const createFolderDiv = document.getElementById('create-folder-div');
    const studentFolderCheckbox = document.getElementById('create_student_folder');

    subjectSelect.addEventListener('change', function() {
      const selectedValue = subjectSelect.value;
      subjectText.value = selectedValue;
      if (selectedValue === "") {
        subjectText.classList.remove('d-none');
      } //
      else {
        subjectText.classList.add('d-none');
      }

      if (selectedValue === "sat/act" || selectedValue === "sat" || selectedValue === "act") {
        studentFolderCheckbox.checked = true;
      } else {
        studentFolderCheckbox.checked = false;
      }
    });

    document.getElementById('parent_id').addEventListener('change', function() {
      if(this.value == 0) {
        document.getElementById('new-parent-info').style.display = 'block';
      }
      else {
        document.getElementById('new-parent-info').style.display = 'none';
      }
    });

    const tutorSelect = document.getElementById('tutor');

    // Set initial location from default tutor
    const initialOption = tutorSelect.options[tutorSelect.selectedIndex];
    const initialLocation = initialOption.getAttribute('data-location');
    document.getElementById('location').value = initialLocation;

    // Update location when tutor changes
    tutorSelect.addEventListener('change', function() {
      const selectedOption = this.options[this.selectedIndex];
      const location = selectedOption.getAttribute('data-location');
      document.getElementById('location').value = location;
    });
  </script>
{% endblock end_scripts %}