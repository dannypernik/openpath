{% extends 'base.html' %}

{% block styles_scripts %}
  {{ super() }}

  <script src="https://cdn.jsdelivr.net/npm/@jaames/iro@5"></script>
{% endblock styles_scripts %}

{% block content %}
<h1>Settings for {{ organization.name or 'new organization' }}</h1>
<form method='post' enctype='multipart/form-data'>
    {{ form.hidden_tag() }}
    <div id="new-org-info" class="mb-2">
      {{ form.org_name }}
      {{ form.slug }}
    </div>
    <div class="mb-1">
      {{ form.partner_id.label }} {{ form.partner_id }}
    </div>
    <div id="new-partner-info" class="row">
      <div class="col col-md-6">
        {{ form.first_name }}
      </div>
      <div class="col col-md-6">
        {{ form.last_name }}
      </div>
      <div class="col">
        {{ form.email }}
      </div>
    </div>
    <div class="row mb-2 text-center">
      <div class="col-12 col-md-6 col-xl-3 mb-2">
      <div id="picker1" class="my-2"></div>
      {{ form.color1.label }}
      {{ form.color1(class="text-center") }}
      </div>
      <div class="col-12 col-md-6 col-xl-3 mb-2">
      <div id="picker2" class="my-2"></div>
      {{ form.color2.label }}
      {{ form.color2(class="text-center") }}
      </div>
      <div class="col-12 col-md-6 col-xl-3 mb-2">
      <div id="picker3" class="my-2"></div>
      {{ form.color3.label }}
      {{ form.color3(class="text-center") }}
      </div>
      <div class="col-12 col-md-6 col-xl-3 mb-2">
      <div id="font_picker" class="my-2"></div>
      {{ form.font_color.label }}
      {{ form.font_color(class="text-center") }}
      </div>
    </div>
    <div>
      {{ form.logo.label }} {{ form.logo }}
    </div>
    <div class="mb-2">
      {{ form.sat_ss_id.label }} {{ form.sat_ss_id }}
    </div>
    <div class="mb-2">
      {{ form.act_ss_id.label }} {{ form.act_ss_id }}
    </div>
    <div class="text-center">
      {{ form.submit }}
      <a href="{{ url_for('org_settings', org='new') }}" class="btn ter sm">New organization</a>
    </div>
</form>
{% endblock %}

{% block end_scripts %}
  <script>
    const slideDown = element => element.style.height = `${element.scrollHeight + 20}px`;
    const slideUp = element => element.style.height = 0;

    // Hide partner info on load if partner_id != 0
    window.addEventListener('DOMContentLoaded', function() {
      const partnerIdElem = document.getElementById('partner_id');
      const partnerInfoElem = document.getElementById('new-partner-info');
      if (partnerIdElem && partnerInfoElem) {
      if (partnerIdElem.value != 0) {
        partnerInfoElem.style.display = 'none';
      } else {
        partnerInfoElem.style.display = 'block';
      }
      }
    });

    document.getElementById('partner_id').addEventListener('change', function() {
      if(this.value == 0) {
        document.getElementById('new-partner-info').style.display = 'block';
      }
      else {
        document.getElementById('new-partner-info').style.display = 'none';
      }
    });

    var colorPicker1 = new iro.ColorPicker('#picker1', {
      width: 150,
      color: document.getElementById('color1').value || '#ffffff',
      layout: [
      { component: iro.ui.Wheel },
      { component: iro.ui.Slider, options: { sliderType: 'value' } }
      ]
    });
    var colorPicker2 = new iro.ColorPicker('#picker2', {
      width: 150,
      color: document.getElementById('color2').value || '#ffffff',
      layout: [
      { component: iro.ui.Wheel },
      { component: iro.ui.Slider, options: { sliderType: 'value' } }
      ]
    });
    var colorPicker3 = new iro.ColorPicker('#picker3', {
      width: 150,
      color: document.getElementById('color3').value || '#ffffff',
      layout: [
      { component: iro.ui.Wheel },
      { component: iro.ui.Slider, options: { sliderType: 'value' } }
      ]
    });
    var fontColorPicker = new iro.ColorPicker('#font_picker', {
      width: 150,
      color: document.getElementById('font_color').value || '#ffffff',
      layout: [
      { component: iro.ui.Wheel },
      { component: iro.ui.Slider, options: { sliderType: 'value' } }
      ]
    });

    // Center pickers in their containers
    document.querySelectorAll('#picker1, #picker2, #picker3, #font_picker').forEach(function(picker) {
      picker.style.display = 'flex';
      picker.style.justifyContent = 'center';
      picker.style.alignItems = 'center';
    });

    // Helper to sync picker and input
    function syncPickerWithInput(picker, inputElem) {
      // Update picker when input changes
      inputElem.addEventListener('input', function() {
      // Only update picker if input matches # + 6 hex characters or just 6 hex characters
      let val = this.value;
      if (/^[0-9A-Fa-f]{6}$/.test(val)) {
        val = '#' + val;
      }
      if (/^#[0-9A-Fa-f]{6}$/.test(val)) {
        picker.color.hexString = val;
      }
      });
      // Update input when picker changes
      picker.on('color:change', function(color) {
      inputElem.value = color.hexString;
      });
    }

    syncPickerWithInput(colorPicker1, document.getElementById('color1'));
    syncPickerWithInput(colorPicker2, document.getElementById('color2'));
    syncPickerWithInput(colorPicker3, document.getElementById('color3'));
    syncPickerWithInput(fontColorPicker, document.getElementById('font_color'));

  </script>
{% endblock end_scripts %}